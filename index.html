<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Premium Referral System</title>
    <style>
        /* (Keep all CSS styles from previous code) */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 500px; margin: 0 auto; }
        .premium-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 24px; padding: 30px; margin-bottom: 25px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.2); }
        .dashboard-header { text-align: center; padding-bottom: 25px; border-bottom: 2px solid rgba(0,0,0,0.05); margin-bottom: 25px; }
        .user-name { font-size: 28px; font-weight: 700; color: #2d3436; margin-bottom: 8px; letter-spacing: -0.3px; }
        .user-id { font-size: 14px; color: #636e72; background: #f8f9fa; padding: 10px 20px; border-radius: 50px; display: inline-block; font-weight: 600; margin-top: 10px; }
        .balance-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 35px 30px; border-radius: 24px; text-align: center; margin-bottom: 25px; box-shadow: 0 15px 40px rgba(102, 126, 234, 0.3); position: relative; overflow: hidden; }
        .balance-card::before { content: 'üí∞'; position: absolute; right: 30px; top: 30px; font-size: 40px; opacity: 0.2; }
        .balance-label { font-size: 16px; opacity: 0.9; margin-bottom: 15px; letter-spacing: 1.5px; font-weight: 600; text-transform: uppercase; }
        .balance-amount { font-size: 64px; font-weight: 800; margin-bottom: 10px; text-shadow: 0 4px 12px rgba(0,0,0,0.2); letter-spacing: -2px; }
        .balance-sub { font-size: 16px; opacity: 0.9; font-weight: 600; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .action-btn { background: white; border: none; border-radius: 20px; padding: 25px 15px; text-align: center; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 30px rgba(0,0,0,0.08); position: relative; overflow: hidden; border: 2px solid transparent; }
        .action-btn:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 40px rgba(0,0,0,0.15); border-color: #667eea; }
        .action-btn .icon { font-size: 32px; margin-bottom: 15px; display: block; }
        .action-btn .title { font-size: 18px; font-weight: 700; color: #2d3436; margin-bottom: 8px; }
        .action-btn .subtitle { font-size: 13px; color: #636e72; line-height: 1.4; }
        .withdraw-btn { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 20px; padding: 25px; width: 100%; text-align: center; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 15px 35px rgba(76, 175, 80, 0.3); margin-bottom: 25px; font-size: 18px; font-weight: 700; letter-spacing: 0.5px; position: relative; overflow: hidden; }
        .withdraw-btn::before { content: 'üí∞'; position: absolute; right: 30px; top: 50%; transform: translateY(-50%); font-size: 24px; opacity: 0.8; }
        .withdraw-btn:hover { transform: translateY(-5px); box-shadow: 0 20px 45px rgba(76, 175, 80, 0.4); }
        .withdraw-btn:disabled { background: linear-gradient(135deg, #ccc 0%, #999 100%); cursor: not-allowed; opacity: 0.7; transform: none !important; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .section-title { font-size: 22px; font-weight: 700; color: #2d3436; margin-bottom: 25px; display: flex; align-items: center; gap: 12px; }
        .section-title span { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .referral-link-container { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 20px; padding: 25px; margin-bottom: 20px; border: 2px dashed #dee2e6; }
        .referral-link-box { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; word-break: break-all; font-family: 'Monaco', 'Courier New', monospace; font-size: 15px; color: #495057; text-align: center; cursor: pointer; border: 2px solid transparent; transition: all 0.3s; font-weight: 600; }
        .referral-link-box:hover { border-color: #667eea; box-shadow: 0 5px 20px rgba(102, 126, 234, 0.1); }
        .referral-id-box { background: #e8f4ff; border-radius: 15px; padding: 20px; text-align: center; border: 2px solid #b3d7ff; }
        .referral-id { font-family: 'Monaco', 'Courier New', monospace; font-size: 22px; font-weight: 800; color: #0066cc; margin: 15px 0; letter-spacing: 1px; }
        .copy-btn { width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 15px; padding: 20px; font-size: 18px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; margin-top: 15px; letter-spacing: 0.5px; }
        .copy-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4); }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 25px; }
        .stat-item { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 20px; padding: 25px; text-align: center; transition: transform 0.3s; }
        .stat-item:hover { transform: translateY(-5px); }
        .stat-value { font-size: 36px; font-weight: 800; color: #2d3436; margin-bottom: 8px; letter-spacing: -1px; }
        .stat-label { font-size: 14px; color: #636e72; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        .requirements-box { background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-radius: 20px; padding: 25px; margin: 25px 0; border: 2px solid #ffd351; }
        .requirements-box h4 { color: #856404; margin-bottom: 15px; font-size: 18px; font-weight: 700; }
        .requirements-box ul { list-style: none; padding: 0; }
        .requirements-box li { padding: 12px 0; border-bottom: 2px dashed rgba(133, 100, 4, 0.2); display: flex; justify-content: space-between; font-size: 15px; font-weight: 600; }
        .requirements-box li:last-child { border-bottom: none; }
        .requirements-box li span:first-child { color: #856404; }
        .requirements-box li span:last-child { color: #2d3436; font-weight: 800; }
        .requirements-status { background: linear-gradient(135deg, #e8f4ff 0%, #d1e7ff 100%); border-radius: 15px; padding: 20px; margin: 20px 0; text-align: center; border: 2px solid #b3d7ff; }
        .requirements-status .status-text { font-size: 16px; font-weight: 700; margin-bottom: 10px; }
        .requirements-status .status-detail { font-size: 14px; color: #636e72; font-weight: 600; }
        .message { padding: 20px; border-radius: 15px; margin: 20px 0; font-size: 15px; text-align: center; font-weight: 600; border: 2px solid transparent; }
        .success { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-color: #b1dfbb; color: #155724; }
        .info { background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%); border-color: #abdde5; color: #0c5460; }
        .error { background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%); border-color: #f1b0b7; color: #721c24; }
        .footer { text-align: center; color: white; padding: 25px 0; font-size: 14px; opacity: 0.8; font-weight: 600; letter-spacing: 0.5px; }
        .safety-badge { display: inline-block; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 6px 15px; border-radius: 50px; font-size: 12px; font-weight: 800; margin-left: 10px; letter-spacing: 0.5px; }
        .safety-features { background: linear-gradient(135deg, #e8f4ff 0%, #d1e7ff 100%); border-radius: 20px; padding: 25px; margin: 25px 0; border: 2px solid #b3d7ff; }
        .safety-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; }
        .safety-item { background: white; border-radius: 15px; padding: 15px; text-align: center; border: 2px solid #e9ecef; }
        .safety-icon { font-size: 24px; margin-bottom: 10px; display: block; }
        .safety-text { font-size: 12px; color: #2d3436; font-weight: 700; }
        .loading { text-align: center; padding: 60px 30px; background: white; border-radius: 25px; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 25px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .copy-notification { position: fixed; top: 30px; right: 30px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); z-index: 1001; animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: none; font-weight: 700; letter-spacing: 0.5px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; animation: fadeIn 0.3s ease; }
        .modal-content { background: white; border-radius: 25px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 25px 70px rgba(0,0,0,0.3); }
        .modal-header { padding: 25px 30px; border-bottom: 2px solid #f8f9fa; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 24px; color: #2d3436; font-weight: 800; letter-spacing: -0.5px; }
        .close-btn { background: none; border: none; font-size: 28px; color: #6c757d; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; transition: all 0.3s; }
        .close-btn:hover { background: #f8f9fa; color: #2d3436; }
        .modal-body { padding: 30px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .action-grid, .stats-grid, .safety-grid { grid-template-columns: 1fr; }
            .balance-amount { font-size: 48px; }
            .modal-content { max-height: 85vh; }
        }
        @media (max-width: 480px) {
            .balance-amount { font-size: 36px; }
            .action-btn { padding: 20px 10px; }
            .modal-header { padding: 20px; }
            .modal-body { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <!-- Content loads here -->
    </div>
    
    <div class="copy-notification" id="copyNotification">
        ‚úÖ Copied to clipboard!
    </div>

    <script>
        // ================= INITIALIZE STORAGE =================
        function initializeStorage() {
            if (!localStorage.getItem('users')) {
                localStorage.setItem('users', JSON.stringify({}));
            }
            if (!localStorage.getItem('settings')) {
                const defaultSettings = {
                    perRefer: 3,           // Changed to $3 as in your example
                    minRefer: 3,
                    minWithdraw: 10,       // Lower minimum for testing
                    botUsername: 'CashofDreamsupi_bot', // Your bot username
                    botToken: '',
                    adminChatId: '',
                    welcomeMessage: 'Welcome to Cash of Dreams! Earn money by inviting friends.',
                    withdrawEnabled: true,
                    maintenanceMode: false,
                    antiFraud: {
                        checkUsername: true,
                        maxAccountsPerIP: 3
                    }
                };
                localStorage.setItem('settings', JSON.stringify(defaultSettings));
            }
            if (!localStorage.getItem('withdrawals')) {
                localStorage.setItem('withdrawals', JSON.stringify([]));
            }
            if (!localStorage.getItem('referrals')) {
                localStorage.setItem('referrals', JSON.stringify({}));
            }
            if (!localStorage.getItem('adminPassword')) {
                localStorage.setItem('adminPassword', '02092929');
            }
        }
        
        // ================= FIXED: PARSE TELEGRAM DATA =================
        function parseTelegramData() {
            const urlParams = new URLSearchParams(window.location.search);
            let userId = urlParams.get('user') || urlParams.get('user_id') || urlParams.get('id');
            let referralCode = null;
            
            console.log("URL Parameters:", Object.fromEntries(urlParams.entries()));
            
            // ‚úÖ FIXED: Check for Telegram start parameter
            const startParam = urlParams.get('start');
            if (startParam) {
                console.log("Found start parameter:", startParam);
                referralCode = startParam;
            } else {
                // Also check for re/ref parameters
                referralCode = urlParams.get('re') || urlParams.get('ref') || urlParams.get('referral');
            }
            
            // Try to get from hash (Telegram WebApp)
            let telegramData = null;
            const hash = window.location.hash;
            
            if (hash && hash.includes('tgWebAppData')) {
                try {
                    const hashParams = new URLSearchParams(hash.substring(1));
                    const tgWebAppData = hashParams.get('tgWebAppData');
                    
                    if (tgWebAppData) {
                        const tgParams = new URLSearchParams(tgWebAppData);
                        const userStr = tgParams.get('user');
                        if (userStr) {
                            telegramData = JSON.parse(decodeURIComponent(userStr));
                            if (telegramData.id) {
                                userId = telegramData.id.toString();
                            }
                        }
                    }
                } catch (e) {
                    console.error("Error parsing Telegram data:", e);
                }
            }
            
            // Generate a user ID if none exists
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            console.log("Parsed Data:", { userId, referralCode, telegramData });
            
            return {
                userId: userId,
                telegramData: telegramData,
                referralId: referralCode
            };
        }
        
        // ================= FIXED: PROCESS REFERRAL =================
        async function processReferral(userData) {
            const { userId, telegramData, referralId } = userData;
            
            console.log("Processing referral for user:", userId, "Referral ID:", referralId);
            
            try {
                let users = JSON.parse(localStorage.getItem('users'));
                const settings = JSON.parse(localStorage.getItem('settings'));
                let referrals = JSON.parse(localStorage.getItem('referrals'));
                
                // ‚úÖ FIXED: Create user if not exists
                if (!users[userId]) {
                    console.log("Creating new user:", userId);
                    users[userId] = createUser(userId, telegramData);
                }
                
                const user = users[userId];
                user.lastActive = new Date().toISOString();
                
                console.log("User referredBy:", user.referredBy);
                console.log("Referral ID to process:", referralId);
                
                // ‚úÖ FIXED: Only process referral if we have a referralId AND user hasn't been referred yet
                if (referralId && !user.referredBy) {
                    console.log("Processing referral code:", referralId);
                    
                    // Find referrer by website referral ID
                    let referrer = null;
                    let referrerId = null;
                    
                    // Search for user with matching referral ID
                    for (const [uid, u] of Object.entries(users)) {
                        if (u.websiteReferralId === referralId) {
                            referrer = u;
                            referrerId = uid;
                            console.log("Found referrer:", referrerId, "with referral ID:", u.websiteReferralId);
                            break;
                        }
                    }
                    
                    if (referrer) {
                        console.log("Referrer found:", referrerId);
                        
                        // Check self-referral
                        if (userId === referrerId) {
                            console.log("Self-referral attempted");
                            return {
                                success: false,
                                message: "You cannot refer yourself"
                            };
                        }
                        
                        // ‚úÖ FIXED: Check if referral already processed
                        const referralKey = `${referrerId}_${userId}`;
                        if (referrals[referralKey]) {
                            console.log("Referral already processed");
                            return {
                                success: false,
                                message: "This referral has already been processed"
                            };
                        }
                        
                        console.log("Processing new referral...");
                        
                        // ‚úÖ Process the referral
                        referrer.refers += 1;
                        referrer.balance += settings.perRefer;
                        referrer.totalEarned = (referrer.totalEarned || 0) + settings.perRefer;
                        
                        if (!referrer.referredUsers) referrer.referredUsers = [];
                        referrer.referredUsers.unshift(userId); // Add to beginning
                        
                        user.referredBy = referrerId;
                        
                        // Record referral
                        referrals[referralKey] = {
                            newUser: userId,
                            referrer: referrerId,
                            date: new Date().toISOString(),
                            amount: settings.perRefer,
                            status: 'success'
                        };
                        
                        console.log("Referral processed successfully!");
                        console.log("Referrer new balance:", referrer.balance);
                        console.log("Referrer new refers count:", referrer.refers);
                        
                        // ‚úÖ FIXED: Save data immediately
                        localStorage.setItem('users', JSON.stringify(users));
                        localStorage.setItem('referrals', JSON.stringify(referrals));
                        
                        // Send Telegram notification if configured
                        if (settings.botToken && referrer.chatId) {
                            try {
                                const message = `üéâ New Referral Success!\n\nNew User: ${user.telegramData?.first_name || userId}\nUsername: @${user.telegramData?.username || 'N/A'}\nBonus: $${settings.perRefer}\nYour new balance: $${referrer.balance.toFixed(2)}\nTotal referrals: ${referrer.refers}`;
                                await sendTelegramAlert(referrer.chatId, message);
                            } catch (e) {
                                console.error("Failed to send notification:", e);
                            }
                        }
                        
                        // Send admin notification
                        if (settings.botToken && settings.adminChatId) {
                            try {
                                const adminMessage = `üìä New Referral Recorded\n\nReferrer: ${referrerId}\nNew User: ${userId}\nName: ${user.telegramData?.first_name || 'N/A'} ${user.telegramData?.last_name || ''}\nUsername: @${user.telegramData?.username || 'N/A'}\nAmount: $${settings.perRefer}`;
                                await sendTelegramAlert(settings.adminChatId, adminMessage);
                            } catch (e) {
                                console.error("Failed to send admin notification:", e);
                            }
                        }
                        
                        return {
                            success: true,
                            message: `üéâ Welcome! You've been referred successfully. $${settings.perRefer} has been added to referrer's account.`,
                            referrerId: referrerId,
                            amount: settings.perRefer
                        };
                    } else {
                        console.log("Referrer not found for code:", referralId);
                        console.log("Available users:", Object.keys(users).map(uid => ({
                            id: uid,
                            referralId: users[uid].websiteReferralId
                        })));
                        
                        return {
                            success: false,
                            message: "Invalid referral code. Please check and try again."
                        };
                    }
                } else if (referralId && user.referredBy) {
                    console.log("User already referred by:", user.referredBy);
                    return {
                        success: false,
                        message: "You have already been referred by another user"
                    };
                }
                
                // No referral code or user already referred
                localStorage.setItem('users', JSON.stringify(users));
                
                if (user.referredBy) {
                    console.log("Returning user with existing referrer");
                    return {
                        success: true,
                        message: "Welcome back! Your referral was already processed.",
                        noReferral: true
                    };
                } else {
                    console.log("New user without referral");
                    return {
                        success: true,
                        message: "Welcome to our premium referral system! Share your link to earn money.",
                        noReferral: true
                    };
                }
                
            } catch (error) {
                console.error("Error in processReferral:", error);
                return {
                    success: false,
                    message: "System error. Please try again."
                };
            }
        }
        
        function createUser(id, telegramData = null) {
            const referralId = generateReferralId();
            console.log("Generated referral ID for new user:", referralId);
            
            return {
                id: id,
                balance: 0,
                refers: 0,
                upi: '',
                pin: null,
                banned: false,
                joined: new Date().toISOString(),
                chatId: id,
                telegramData: telegramData,
                withdrawHistory: [],
                referredUsers: [],
                referredBy: null,
                websiteReferralId: referralId,
                lastActive: new Date().toISOString(),
                totalEarned: 0,
                totalWithdrawn: 0
            };
        }
        
        function generateReferralId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }
        
        async function sendTelegramAlert(chatId, message) {
            const settings = JSON.parse(localStorage.getItem('settings'));
            
            if (!settings.botToken || !chatId) {
                return false;
            }
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${settings.botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });
                return response.ok;
            } catch (error) {
                console.error("Telegram error:", error);
                return false;
            }
        }
        
        // ================= MAIN LOADING =================
        document.addEventListener('DOMContentLoaded', function() {
            initializeStorage();
            
            const urlParams = new URLSearchParams(window.location.search);
            const page = urlParams.get('page');
            
            if (page === 'admin') {
                handleAdminPage();
                return;
            }
            
            const userData = parseTelegramData();
            console.log("Loaded user data:", userData);
            
            if (userData.userId) {
                showLoading("Setting up your account...");
                
                // Process referral immediately
                setTimeout(() => {
                    processReferral(userData)
                        .then(result => {
                            console.log("Referral result:", result);
                            showUserDashboard(userData.userId, userData.telegramData, result);
                        })
                        .catch(error => {
                            console.error("Error in main:", error);
                            showUserDashboard(userData.userId, userData.telegramData, {
                                success: false,
                                message: "Error processing request"
                            });
                        });
                }, 1000);
            } else {
                showWelcomeScreen();
            }
        });
        
        function showLoading(message) {
            document.getElementById('app').innerHTML = `
                <div class="premium-card loading">
                    <div class="loading-spinner"></div>
                    <h3 style="text-align: center; color: #2d3436; font-weight: 600;">${message}</h3>
                </div>
            `;
        }
        
        function showWelcomeScreen() {
            document.getElementById('app').innerHTML = `
                <div class="premium-card">
                    <div class="dashboard-header">
                        <h1 style="color: #2d3436; margin-bottom: 15px;">üí∞ Premium Referral System</h1>
                        <p style="color: #636e72; margin-bottom: 25px;">Please open this link from Telegram to continue</p>
                        <button class="copy-btn" onclick="location.href='?page=admin'" style="margin-top: 20px;">
                            üîß Admin Panel
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ================= USER DASHBOARD =================
        function showUserDashboard(userId, telegramData, result) {
            const users = JSON.parse(localStorage.getItem('users'));
            const settings = JSON.parse(localStorage.getItem('settings'));
            
            // Ensure user exists
            if (!users[userId]) {
                console.log("Creating user in dashboard:", userId);
                users[userId] = createUser(userId, telegramData);
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            const user = users[userId];
            user.lastActive = new Date().toISOString();
            localStorage.setItem('users', JSON.stringify(users));
            
            console.log("User data for dashboard:", user);
            
            const botUsername = settings.botUsername || 'CashofDreamsupi_bot';
            const telegramReferralLink = `https://t.me/${botUsername}?start=${user.websiteReferralId}`;
            
            // Calculate withdrawal eligibility
            const canWithdraw = user.balance >= settings.minWithdraw && user.refers >= settings.minRefer;
            const missingReferrals = Math.max(0, settings.minRefer - user.refers);
            const missingBalance = Math.max(0, settings.minWithdraw - user.balance);
            
            let withdrawButton = '';
            if (canWithdraw && settings.withdrawEnabled) {
                withdrawButton = `
                    <button class="withdraw-btn" onclick="showWithdraw('${userId}')">
                        üí∞ WITHDRAW NOW
                    </button>
                `;
            } else {
                let disableReason = '';
                if (!settings.withdrawEnabled) {
                    disableReason = 'Withdrawals are currently disabled';
                } else if (user.balance < settings.minWithdraw && user.refers < settings.minRefer) {
                    disableReason = `Need ${missingReferrals} more referrals and $${missingBalance.toFixed(2)} more balance`;
                } else if (user.refers < settings.minRefer) {
                    disableReason = `Need ${missingReferrals} more referrals`;
                } else {
                    disableReason = `Need $${missingBalance.toFixed(2)} more balance`;
                }
                
                withdrawButton = `
                    <button class="withdraw-btn" disabled title="${disableReason}">
                        ‚è≥ WITHDRAW (Requirements not met)
                    </button>
                `;
            }
            
            // ‚úÖ Get referred users in reverse order (newest first)
            let referredUsersHTML = '';
            if (user.referredUsers && user.referredUsers.length > 0) {
                user.referredUsers.slice(0, 5).forEach((refId, index) => {
                    const refUser = users[refId];
                    if (refUser) {
                        referredUsersHTML += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; border-radius: 10px; margin-bottom: 8px;">
                                <div>
                                    <div style="font-weight: 700; color: #2d3436;">${refUser.telegramData?.first_name || 'User'}</div>
                                    <div style="font-size: 12px; color: #636e72;">ID: ${refId.slice(0, 8)}...</div>
                                </div>
                                <div style="color: #28a745; font-weight: 900; font-size: 16px;">
                                    +$${settings.perRefer}
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            document.getElementById('app').innerHTML = `
                <!-- User Info Card -->
                <div class="premium-card">
                    <div class="dashboard-header">
                        ${result.message ? `
                            <div class="${result.success ? 'success' : 'error'} message">
                                ${result.message}
                            </div>
                        ` : ''}
                        
                        <div class="user-name">
                            ${user.telegramData?.first_name || 'User'} ${user.telegramData?.last_name || ''}
                            <span class="safety-badge">‚úÖ VERIFIED</span>
                        </div>
                        
                        ${user.telegramData?.username ? `
                            <div style="color: #667eea; margin-bottom: 10px; font-weight: 600;">
                                @${user.telegramData.username}
                            </div>
                        ` : ''}
                        
                        <div class="user-id">ID: ${userId}</div>
                        
                        <div style="margin-top: 20px; color: #636e72; font-size: 14px; font-weight: 600;">
                            ${settings.welcomeMessage}
                        </div>
                    </div>
                </div>
                
                <!-- Balance Card -->
                <div class="balance-card">
                    <div class="balance-label">YOUR BALANCE</div>
                    <div class="balance-amount">$${user.balance.toFixed(2)}</div>
                    <div class="balance-sub">${user.refers} referrals ‚Ä¢ $${(user.refers * settings.perRefer).toFixed(2)} earned</div>
                </div>
                
                <!-- Withdraw Button -->
                ${withdrawButton}
                
                <!-- Quick Actions -->
                <div class="premium-card">
                    <div class="action-grid">
                        <button class="action-btn" onclick="showReferralStats('${userId}')">
                            <div class="icon">üìä</div>
                            <div class="title">Referral Stats</div>
                            <div class="subtitle">View earnings & history</div>
                        </button>
                        
                        <button class="action-btn" onclick="showRequirements('${userId}')">
                            <div class="icon">üìã</div>
                            <div class="title">Requirements</div>
                            <div class="subtitle">Withdrawal conditions</div>
                        </button>
                    </div>
                </div>
                
                <!-- Referral Section -->
                <div class="premium-card">
                    <div class="section-title">
                        <span>üîó</span> Your Referral Link
                    </div>
                    
                    <div class="referral-link-container">
                        <div style="font-size: 15px; color: #636e72; margin-bottom: 15px; font-weight: 600;">
                            Share this link to earn <strong style="color: #28a745;">$${settings.perRefer}</strong> for every new user
                        </div>
                        
                        <div class="referral-link-box" id="referralLink" onclick="copyLinkToClipboard()" title="Click to copy">
                            ${telegramReferralLink}
                        </div>
                        
                        <div class="referral-id-box">
                            <div style="font-size: 15px; color: #636e72; margin-bottom: 5px; font-weight: 600;">
                                Your Referral ID:
                            </div>
                            <div class="referral-id" id="referralId" onclick="copyIdToClipboard()" style="cursor: pointer;" title="Click to copy">
                                ${user.websiteReferralId}
                            </div>
                            <div style="font-size: 13px; color: #7f8c8d; margin-top: 8px; font-weight: 600;">
                                Share this ID or the full link above
                            </div>
                        </div>
                        
                        <button class="copy-btn" onclick="copyLinkToClipboard()">
                            üìã Copy Telegram Link
                        </button>
                    </div>
                </div>
                
                <!-- Recent Referrals (Top) -->
                ${user.referredUsers && user.referredUsers.length > 0 ? `
                <div class="premium-card">
                    <div class="section-title">
                        <span>üë•</span> Recent Referrals
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${referredUsersHTML}
                    </div>
                    ${user.referredUsers.length > 5 ? `
                        <div style="text-align: center; margin-top: 15px; color: #667eea; font-weight: 700;">
                            + ${user.referredUsers.length - 5} more referrals
                        </div>
                    ` : ''}
                </div>
                ` : ''}
                
                <!-- Safety Features -->
                <div class="premium-card">
                    <div class="section-title">
                        <span>üõ°Ô∏è</span> Safety Features
                    </div>
                    <div class="safety-features">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <div style="font-size: 18px; font-weight: 800; color: #0066cc;">100% Secure Platform</div>
                            <div style="font-size: 14px; color: #636e72; margin-top: 5px;">Your earnings are protected</div>
                        </div>
                        
                        <div class="safety-grid">
                            <div class="safety-item">
                                <div class="safety-icon">üîí</div>
                                <div class="safety-text">Secure PIN</div>
                            </div>
                            <div class="safety-item">
                                <div class="safety-icon">‚úÖ</div>
                                <div class="safety-text">Verified Users</div>
                            </div>
                            <div class="safety-item">
                                <div class="safety-icon">üõ°Ô∏è</div>
                                <div class="safety-text">Anti-Fraud</div>
                            </div>
                            <div class="safety-item">
                                <div class="safety-icon">üí∞</div>
                                <div class="safety-text">Instant Payments</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Requirements Box -->
                <div class="premium-card">
                    <div class="requirements-box">
                        <h4>üìã Withdrawal Requirements</h4>
                        <ul>
                            <li>
                                <span>Minimum referrals:</span>
                                <span>${settings.minRefer} (You have: ${user.refers})</span>
                            </li>
                            <li>
                                <span>Minimum withdrawal:</span>
                                <span>$${settings.minWithdraw}</span>
                            </li>
                            <li>
                                <span>Bonus per referral:</span>
                                <span>$${settings.perRefer}</span>
                            </li>
                            <li>
                                <span>Withdrawals enabled:</span>
                                <span>${settings.withdrawEnabled ? '‚úÖ Yes' : '‚ùå No'}</span>
                            </li>
                        </ul>
                    </div>
                    
                    <div class="requirements-status">
                        <div class="status-text" style="color: ${canWithdraw ? '#28a745' : '#dc3545'};">
                            ${canWithdraw ? '‚úÖ Ready to withdraw!' : '‚ùå Requirements not met'}
                        </div>
                        <div class="status-detail">
                            ${canWithdraw ? 
                                'You meet all withdrawal requirements!' : 
                                user.refers < settings.minRefer ? 
                                    `Need ${missingReferrals} more referrals` : 
                                    `Need $${missingBalance.toFixed(2)} more balance`
                            }
                        </div>
                    </div>
                </div>
                
                <!-- Stats -->
                <div class="premium-card">
                    <div class="section-title">
                        <span>üìà</span> Quick Stats
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-value">${user.refers}</div>
                            <div class="stat-label">Total Referrals</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">$${user.balance.toFixed(2)}</div>
                            <div class="stat-label">Available Balance</div>
                        </div>
                    </div>
                    
                    <button class="copy-btn" onclick="location.reload()" style="background: #6c757d; margin-top: 20px;">
                        üîÑ Refresh Page
                    </button>
                </div>
                
                <div class="footer">
                    Premium Referral System ‚Ä¢ User ID: ${userId} ‚Ä¢ ${new Date().toLocaleDateString()}
                </div>
            `;
        }
        
        // ================= UTILITY FUNCTIONS =================
        window.copyLinkToClipboard = function() {
            const link = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                const notification = document.getElementById('copyNotification');
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 2000);
            });
        };
        
        window.copyIdToClipboard = function() {
            const id = document.getElementById('referralId').textContent;
            navigator.clipboard.writeText(id).then(() => {
                const notification = document.getElementById('copyNotification');
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 2000);
            });
        };
        
        // ================= DEBUG FUNCTION =================
        window.debugReferrals = function() {
            const users = JSON.parse(localStorage.getItem('users'));
            const referrals = JSON.parse(localStorage.getItem('referrals'));
            
            console.log("=== DEBUG REFERRALS ===");
            console.log("Total Users:", Object.keys(users).length);
            console.log("Users:", users);
            console.log("Total Referrals:", Object.keys(referrals).length);
            console.log("Referrals:", referrals);
            
            alert(`Total Users: ${Object.keys(users).length}\nTotal Referrals: ${Object.keys(referrals).length}\nCheck console for details.`);
        };
        
        // Add debug button to admin panel (optional)
    </script>
</body>
  </html>
