<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Referral System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #fff; color: #000; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .balance-box { background: #f5f5f5; border-radius: 10px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .balance-label { font-size: 14px; color: #666; margin-bottom: 5px; }
        .balance-amount { font-size: 32px; font-weight: bold; }
        .button-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .action-btn { background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 15px; text-align: center; cursor: pointer; }
        .action-btn .icon { font-size: 24px; margin-bottom: 10px; }
        .action-btn .title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        .action-btn .subtitle { font-size: 12px; color: #666; }
        .referral-section { background: #f5f5f5; border-radius: 10px; padding: 20px; }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .referral-link-box { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 15px; word-break: break-all; font-family: monospace; font-size: 13px; }
        .copy-btn { width: 100%; background: #007aff; color: white; border: none; border-radius: 8px; padding: 12px; font-weight: bold; cursor: pointer; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; border-radius: 10px; width: 90%; max-width: 400px; }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 18px; font-weight: bold; }
        .close-btn { background: none; border: none; font-size: 24px; color: #666; cursor: pointer; }
        .modal-body { padding: 20px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 14px; color: #666; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .submit-btn { width: 100%; background: #007aff; color: white; border: none; border-radius: 8px; padding: 12px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; text-align: center; }
        .stat-box .value { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
        .stat-box .label { font-size: 12px; color: #666; }
        .error { background: #fee; border: 1px solid #f99; border-radius: 8px; padding: 10px; margin: 10px 0; color: #c00; font-size: 14px; }
        .success { background: #efe; border: 1px solid #9f9; border-radius: 8px; padding: 10px; margin: 10px 0; color: #090; font-size: 14px; }
        .maintenance { background: #ffd; border: 1px solid #dd9; border-radius: 8px; padding: 15px; text-align: center; margin: 20px 0; color: #660; }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <div class="modal" id="withdrawModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Withdraw</h2>
                <button class="close-btn" onclick="closeModal('withdrawModal')">Ã—</button>
            </div>
            <div class="modal-body" id="withdrawModalBody"></div>
        </div>
    </div>

    <div class="modal" id="referralModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Referral Stats</h2>
                <button class="close-btn" onclick="closeModal('referralModal')">Ã—</button>
            </div>
            <div class="modal-body" id="referralModalBody"></div>
        </div>
    </div>

    <div class="modal" id="pinModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="pinModalTitle">PIN</h2>
                <button class="close-btn" onclick="closeModal('pinModal')">Ã—</button>
            </div>
            <div class="modal-body" id="pinModalBody"></div>
        </div>
    </div>

    <script>
        // ================= SIMPLE API HANDLER =================
        function handleRequest() {
            const urlParams = new URLSearchParams(window.location.search);
            const api = urlParams.get('api');
            const page = urlParams.get('page');
            const uid = urlParams.get('uid') || urlParams.get('user');
            const ref = urlParams.get('ref');
            
            // Initialize data
            if (!localStorage.getItem('users')) localStorage.setItem('users', '{}');
            if (!localStorage.getItem('settings')) localStorage.setItem('settings', JSON.stringify({
                perRefer: 5, minRefer: 3, minWithdraw: 20, botUser: 'YourBotUsername', withdrawEnabled: true
            }));
            if (!localStorage.getItem('withdrawals')) localStorage.setItem('withdrawals', '[]');
            if (!localStorage.getItem('alerts')) localStorage.setItem('alerts', JSON.stringify({
                withdrawAlert: true, referralAlert: true, referralAdminAlert: true
            }));
            if (!localStorage.getItem('adminPassword')) localStorage.setItem('adminPassword', '02092929');
            
            // Handle API request
            if (api) {
                let response = {};
                const users = JSON.parse(localStorage.getItem('users'));
                const settings = JSON.parse(localStorage.getItem('settings'));
                
                try {
                    if (api === 'directref' && uid && ref && uid !== ref) {
                        if (!users[uid]) users[uid] = {balance: 0, refers: 0, upi: '', pin: null, banned: false, joined: new Date().toISOString()};
                        if (!users[ref]) users[ref] = {balance: 0, refers: 0, upi: '', pin: null, banned: false, joined: new Date().toISOString()};
                        
                        const referralKey = `${uid}_${ref}`;
                        if (!localStorage.getItem(referralKey) && !users[ref].banned) {
                            users[ref].refers += 1;
                            users[ref].balance += settings.perRefer;
                            localStorage.setItem(referralKey, 'true');
                            localStorage.setItem('users', JSON.stringify(users));
                            
                            response = {
                                success: true,
                                ref: ref,
                                refers: users[ref].refers,
                                balance: users[ref].balance
                            };
                        } else {
                            response = {error: users[ref].banned ? 'Referrer banned' : 'Already referred'};
                        }
                    }
                    else if (api === 'user' && uid) {
                        if (!users[uid]) users[uid] = {balance: 0, refers: 0, upi: '', pin: null, banned: false, joined: new Date().toISOString()};
                        localStorage.setItem('users', JSON.stringify(users));
                        
                        response = {
                            uid: uid,
                            balance: users[uid].balance,
                            refers: users[uid].refers,
                            canWithdraw: users[uid].refers >= settings.minRefer && users[uid].balance >= settings.minWithdraw
                        };
                    }
                    else if (api === 'setchatid' && uid) {
                        const chatId = urlParams.get('chat_id');
                        if (chatId) {
                            if (!users[uid]) users[uid] = {balance: 0, refers: 0, upi: '', pin: null, banned: false, joined: new Date().toISOString()};
                            users[uid].chatId = chatId;
                            localStorage.setItem('users', JSON.stringify(users));
                            response = {success: true};
                        }
                    }
                    else {
                        response = {error: 'Invalid API'};
                    }
                } catch (e) {
                    response = {error: e.message};
                }
                
                // Plain text response for API
                document.getElementById('app').innerHTML = `<pre>${JSON.stringify(response)}</pre>`;
                return;
            }
            
            // Handle admin page
            if (page === 'admin') {
                if (sessionStorage.getItem('adminAuthenticated') !== 'true') {
                    showAdminLogin();
                } else {
                    showAdminPanel();
                }
                return;
            }
            
            // Handle user dashboard
            if (uid) {
                showUserDashboard(uid);
            } else {
                document.getElementById('app').innerHTML = '<div class="error">User ID required</div>';
            }
        }

        // ================= USER DASHBOARD =================
        function showUserDashboard(userId) {
            const users = JSON.parse(localStorage.getItem('users'));
            const settings = JSON.parse(localStorage.getItem('settings'));
            
            if (!users[userId]) {
                users[userId] = {balance: 0, refers: 0, upi: '', pin: null, banned: false, joined: new Date().toISOString()};
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            const user = users[userId];
            
            // Check maintenance mode
            if (settings.maintenanceMode) {
                document.getElementById('app').innerHTML = `
                    <div class="maintenance">
                        <h2>ðŸš§ Maintenance</h2>
                        <p>System under maintenance. Try again later.</p>
                    </div>
                `;
                return;
            }
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <h1>$${user.balance.toFixed(2)}</h1>
                </div>
                
                <div class="button-grid">
                    <div class="action-btn" onclick="showReferralStats('${userId}')">
                        <div class="icon">ðŸ“Š</div>
                        <div class="title">Referrals</div>
                        <div class="subtitle">${user.refers}</div>
                    </div>
                    
                    <div class="action-btn" onclick="showWithdraw('${userId}')" ${settings.withdrawEnabled === false ? 'style="opacity:0.5"' : ''}>
                        <div class="icon">ðŸ’°</div>
                        <div class="title">Withdraw</div>
                        <div class="subtitle">${settings.withdrawEnabled === false ? 'Disabled' : 'Tap'}</div>
                    </div>
                </div>
                
                <div class="referral-section">
                    <div class="section-title">Referral Link</div>
                    <div class="referral-link-box" id="referralLink">
                        https://t.me/${settings.botUser || 'bot'}?start=${userId}
                    </div>
                    <button class="copy-btn" onclick="copyReferralLink()">Copy</button>
                </div>
            `;
        }

        // ================= ADMIN PANEL =================
        function showAdminLogin() {
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <h1>Admin Login</h1>
                </div>
                <div style="max-width: 400px; margin: 50px auto;">
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="adminPassword" placeholder="Enter password">
                    </div>
                    <button class="submit-btn" onclick="adminLogin()">Login</button>
                    <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #666;">
                        Default: 02092929
                    </div>
                </div>
            `;
        }

        function adminLogin() {
            const password = document.getElementById('adminPassword').value;
            const storedPassword = localStorage.getItem('adminPassword') || '02092929';
            
            if (password === storedPassword) {
                sessionStorage.setItem('adminAuthenticated', 'true');
                showAdminPanel();
            } else {
                showMessage('Wrong password', 'error');
            }
        }

        function showAdminPanel() {
            const settings = JSON.parse(localStorage.getItem('settings'));
            const alerts = JSON.parse(localStorage.getItem('alerts'));
            const users = JSON.parse(localStorage.getItem('users'));
            const withdrawals = JSON.parse(localStorage.getItem('withdrawals'));
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <h1>Admin Panel</h1>
                    <div style="margin-top: 10px;">
                        <button class="submit-btn" style="width: auto; padding: 8px 16px; margin: 5px;" onclick="adminLogout()">Logout</button>
                        <button class="submit-btn" style="width: auto; padding: 8px 16px; margin: 5px; background: #34c759;" onclick="showChangePassword()">Change Password</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <input type="checkbox" id="withdrawEnabled" ${settings.withdrawEnabled !== false ? 'checked' : ''} style="margin-right: 10px;">
                        <label>Withdraw Enabled</label>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <input type="checkbox" id="maintenanceMode" ${settings.maintenanceMode ? 'checked' : ''} style="margin-right: 10px;">
                        <label>Maintenance Mode</label>
                    </div>
                    <button class="submit-btn" onclick="saveSystemControl()">Save System Control</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <input type="checkbox" id="withdrawAlert" ${alerts.withdrawAlert !== false ? 'checked' : ''} style="margin-right: 10px;">
                        <label>Withdraw Alerts</label>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <input type="checkbox" id="referralAlert" ${alerts.referralAlert !== false ? 'checked' : ''} style="margin-right: 10px;">
                        <label>Referral Alerts</label>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <input type="checkbox" id="referralAdminAlert" ${alerts.referralAdminAlert !== false ? 'checked' : ''} style="margin-right: 10px;">
                        <label>Referral Admin Alerts</label>
                    </div>
                    <button class="submit-btn" onclick="saveAlertSettings()">Save Alert Settings</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div class="input-group">
                        <label>Bot Token</label>
                        <input type="text" id="botToken" value="${settings.botToken || ''}">
                    </div>
                    <div class="input-group">
                        <label>Admin Chat ID</label>
                        <input type="text" id="adminChatId" value="${settings.adminChatId || ''}">
                    </div>
                    <div class="input-group">
                        <label>Bot Username</label>
                        <input type="text" id="botUser" value="${settings.botUser || ''}">
                    </div>
                    <button class="submit-btn" onclick="saveBotConfig()">Save Bot Config</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div class="input-group">
                        <label>Bonus per Referral ($)</label>
                        <input type="number" id="perRefer" value="${settings.perRefer || 5}" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Min Referrals Required</label>
                        <input type="number" id="minRefer" value="${settings.minRefer || 3}">
                    </div>
                    <div class="input-group">
                        <label>Min Withdrawal ($)</label>
                        <input type="number" id="minWithdraw" value="${settings.minWithdraw || 20}" step="0.01">
                    </div>
                    <button class="submit-btn" onclick="saveReferralSettings()">Save Referral Settings</button>
                </div>
                
                <div>
                    <div style="margin-bottom: 10px;">Total Users: ${Object.keys(users).length}</div>
                    <div style="margin-bottom: 10px;">Total Withdrawals: ${withdrawals.length}</div>
                    <div>Pending: ${withdrawals.filter(w => !w.status || w.status === 'Pending').length}</div>
                </div>
            `;
        }

        // ================= MODAL FUNCTIONS =================
        window.showWithdraw = function(userId) {
            const users = JSON.parse(localStorage.getItem('users'));
            const settings = JSON.parse(localStorage.getItem('settings'));
            const user = users[userId];
            
            if (settings.withdrawEnabled === false) {
                showMessage('Withdrawals disabled', 'error');
                return;
            }
            
            if (!user.pin) {
                showSetPinModal(userId);
                return;
            }
            
            showVerifyPinModal(userId);
        };

        function showSetPinModal(userId) {
            document.getElementById('pinModalTitle').textContent = 'Set PIN';
            document.getElementById('pinModalBody').innerHTML = `
                <div class="input-group">
                    <label>4-digit PIN</label>
                    <input type="password" id="pinInput" maxlength="4" placeholder="0000">
                </div>
                <div class="input-group">
                    <label>Confirm PIN</label>
                    <input type="password" id="confirmPinInput" maxlength="4" placeholder="0000">
                </div>
                <button class="submit-btn" onclick="savePin('${userId}')">Set PIN</button>
            `;
            openModal('pinModal');
        }

        function showVerifyPinModal(userId) {
            document.getElementById('pinModalTitle').textContent = 'Enter PIN';
            document.getElementById('pinModalBody').innerHTML = `
                <div class="input-group">
                    <label>Enter PIN</label>
                    <input type="password" id="pinInput" maxlength="4" placeholder="0000">
                </div>
                <button class="submit-btn" onclick="verifyPin('${userId}')">Continue</button>
            `;
            openModal('pinModal');
        }

        window.savePin = function(userId) {
            const pin = document.getElementById('pinInput').value;
            const confirmPin = document.getElementById('confirmPinInput').value;
            
            if (pin.length !== 4) {
                showMessage('4 digits required', 'error');
                return;
            }
            
            if (pin !== confirmPin) {
                showMessage('PINs dont match', 'error');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users'));
            users[userId].pin = pin;
            localStorage.setItem('users', JSON.stringify(users));
            
            closeModal('pinModal');
            showMessage('PIN set', 'success');
            setTimeout(() => showWithdrawModal(userId), 500);
        };

        window.verifyPin = function(userId) {
            const enteredPin = document.getElementById('pinInput').value;
            const users = JSON.parse(localStorage.getItem('users'));
            const user = users[userId];
            
            if (enteredPin !== user.pin) {
                showMessage('Wrong PIN', 'error');
                return;
            }
            
            closeModal('pinModal');
            showWithdrawModal(userId);
        };

        function showWithdrawModal(userId) {
            const users = JSON.parse(localStorage.getItem('users'));
            const settings = JSON.parse(localStorage.getItem('settings'));
            const user = users[userId];
            
            const lastAttempt = user.lastWithdrawAttempt;
            const now = new Date();
            let timeLeft = 0;
            
            if (lastAttempt) {
                const lastTime = new Date(lastAttempt);
                const diffMinutes = (now - lastTime) / (1000 * 60);
                timeLeft = Math.max(0, 5 - Math.floor(diffMinutes));
            }
            
            document.getElementById('withdrawModalBody').innerHTML = `
                ${timeLeft > 0 ? `<div class="error">Wait ${timeLeft} minute(s)</div>` : ''}
                <div class="input-group">
                    <label>UPI ID</label>
                    <input type="text" id="upiInput" value="${user.upi || ''}" placeholder="yourname@upi">
                </div>
                <div class="input-group">
                    <label>Amount ($)</label>
                    <input type="number" id="amountInput" 
                           min="${settings.minWithdraw || 20}" 
                           max="${user.balance}" 
                           step="0.01"
                           placeholder="${settings.minWithdraw || 20}">
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Available: $${user.balance.toFixed(2)}
                    </div>
                </div>
                ${timeLeft === 0 ? `
                    <button class="submit-btn" onclick="submitWithdrawal('${userId}')">
                        Submit
                    </button>
                ` : `
                    <button class="submit-btn" disabled>Wait ${timeLeft}m</button>
                `}
            `;
            openModal('withdrawModal');
        }

        window.submitWithdrawal = async function(userId) {
            const upi = document.getElementById('upiInput').value.trim();
            const amount = parseFloat(document.getElementById('amountInput').value);
            
            const users = JSON.parse(localStorage.getItem('users'));
            const settings = JSON.parse(localStorage.getItem('settings'));
            const withdrawals = JSON.parse(localStorage.getItem('withdrawals') || '[]');
            const user = users[userId];
            
            // Validation
            if (!upi) {
                showMessage('Enter UPI', 'error');
                return;
            }
            
            if (!amount || amount < (settings.minWithdraw || 20)) {
                showMessage(`Min: $${settings.minWithdraw || 20}`, 'error');
                return;
            }
            
            if (amount > user.balance) {
                showMessage('Not enough balance', 'error');
                return;
            }
            
            if (user.refers < (settings.minRefer || 3)) {
                showMessage(`Need ${settings.minRefer || 3} referrals`, 'error');
                return;
            }
            
            // Process withdrawal
            user.balance -= amount;
            user.upi = upi;
            user.lastWithdrawAttempt = new Date().toISOString();
            
            const withdrawal = {
                uid: userId,
                upi: upi,
                amount: amount,
                date: new Date().toLocaleString(),
                status: 'Pending'
            };
            
            if (!user.withdrawHistory) user.withdrawHistory = [];
            user.withdrawHistory.push(withdrawal);
            withdrawals.push(withdrawal);
            
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('withdrawals', JSON.stringify(withdrawals));
            
            // Send alerts (plain text, no HTML)
            const alerts = JSON.parse(localStorage.getItem('alerts'));
            if (alerts.withdrawAlert && user.chatId && settings.botToken) {
                await sendTelegramAlert(user.chatId, `Withdrawal request: $${amount.toFixed(2)} to ${upi}. Status: Pending.`);
            }
            if (settings.adminChatId && settings.botToken) {
                await sendTelegramAlert(settings.adminChatId, `New withdrawal: ${userId} - $${amount.toFixed(2)} to ${upi}.`);
            }
            
            closeModal('withdrawModal');
            showMessage(`Request submitted: $${amount.toFixed(2)}`, 'success');
            setTimeout(() => location.reload(), 1000);
        };

        window.showReferralStats = function(userId) {
            const users = JSON.parse(localStorage.getItem('users'));
            const settings = JSON.parse(localStorage.getItem('settings'));
            const user = users[userId];
            
            document.getElementById('referralModalBody').innerHTML = `
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="value">${user.refers}</div>
                        <div class="label">Total</div>
                    </div>
                    <div class="stat-box">
                        <div class="value">$${(user.refers * (settings.perRefer || 5)).toFixed(2)}</div>
                        <div class="label">Earned</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <div>Per referral: $${settings.perRefer || 5}</div>
                    <div>Min required: ${settings.minRefer || 3}</div>
                    <div>Min withdraw: $${settings.minWithdraw || 20}</div>
                </div>
            `;
            openModal('referralModal');
        };

        window.copyReferralLink = function() {
            const link = document.getElementById('referralLink').textContent;
            navigator.clipboard.writeText(link).then(() => {
                showMessage('Copied', 'success');
            });
        };

        // ================= ADMIN FUNCTIONS =================
        window.saveSystemControl = function() {
            const settings = JSON.parse(localStorage.getItem('settings'));
            settings.withdrawEnabled = document.getElementById('withdrawEnabled').checked;
            settings.maintenanceMode = document.getElementById('maintenanceMode').checked;
            localStorage.setItem('settings', JSON.stringify(settings));
            showMessage('Saved', 'success');
        };

        window.saveAlertSettings = function() {
            const alerts = {
                withdrawAlert: document.getElementById('withdrawAlert').checked,
                referralAlert: document.getElementById('referralAlert').checked,
                referralAdminAlert: document.getElementById('referralAdminAlert').checked
            };
            localStorage.setItem('alerts', JSON.stringify(alerts));
            showMessage('Saved', 'success');
        };

        window.saveBotConfig = function() {
            const settings = JSON.parse(localStorage.getItem('settings'));
            settings.botToken = document.getElementById('botToken').value;
            settings.adminChatId = document.getElementById('adminChatId').value;
            settings.botUser = document.getElementById('botUser').value;
            localStorage.setItem('settings', JSON.stringify(settings));
            showMessage('Saved', 'success');
        };

        window.saveReferralSettings = function() {
            const settings = JSON.parse(localStorage.getItem('settings'));
            settings.perRefer = parseFloat(document.getElementById('perRefer').value) || 5;
            settings.minRefer = parseInt(document.getElementById('minRefer').value) || 3;
            settings.minWithdraw = parseFloat(document.getElementById('minWithdraw').value) || 20;
            localStorage.setItem('settings', JSON.stringify(settings));
            showMessage('Saved', 'success');
        };

        window.showChangePassword = function() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Change Password</h2>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <div class="input-group">
                            <label>Current Password</label>
                            <input type="password" id="currentPassword">
                        </div>
                        <div class="input-group">
                            <label>New Password</label>
                            <input type="password" id="newPassword">
                        </div>
                        <div class="input-group">
                            <label>Confirm New Password</label>
                            <input type="password" id="confirmPassword">
                        </div>
                        <button class="submit-btn" onclick="changeAdminPassword()">Change</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };

        window.changeAdminPassword = function() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            const storedPassword = localStorage.getItem('adminPassword') || '02092929';
            
            if (!currentPassword) {
                showMessage('Enter current password', 'error');
                return;
            }
            
            if (currentPassword !== storedPassword) {
                showMessage('Wrong current password', 'error');
                return;
            }
            
            if (!newPassword) {
                showMessage('Enter new password', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showMessage('Password too short', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage('Passwords dont match', 'error');
                return;
            }
            
            localStorage.setItem('adminPassword', newPassword);
            document.querySelector('.modal.active').remove();
            showMessage('Password changed', 'success');
            
            setTimeout(() => {
                sessionStorage.removeItem('adminAuthenticated');
                location.href = '?page=admin';
            }, 1500);
        };

        window.adminLogout = function() {
            sessionStorage.removeItem('adminAuthenticated');
            location.href = '?page=admin';
        };

        // ================= UTILITIES =================
        async function sendTelegramAlert(chatId, message) {
            const settings = JSON.parse(localStorage.getItem('settings'));
            if (!settings.botToken || !chatId) return false;
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${settings.botToken}/sendMessage`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'Markdown' // Use Markdown instead of HTML
                    })
                });
                return response.ok;
            } catch (error) {
                console.error('Telegram alert error:', error);
                return false;
            }
        }

        window.openModal = function(modalId) {
            document.getElementById(modalId).classList.add('active');
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).classList.remove('active');
        };

        function showMessage(message, type) {
            const el = document.createElement('div');
            el.className = type === 'error' ? 'error' : 'success';
            el.textContent = message;
            el.style.marginTop = '20px';
            
            const app = document.getElementById('app');
            app.insertBefore(el, app.firstChild);
            
            setTimeout(() => el.remove(), 3000);
        }

        // Close modal on outside click
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });

        // ================= INITIALIZE =================
        document.addEventListener('DOMContentLoaded', handleRequest);
    </script>
</body>
  </html>
